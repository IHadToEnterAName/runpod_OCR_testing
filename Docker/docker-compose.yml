# =============================================================================
# Production RAG Stack - Docker Compose
# =============================================================================
#
# IMPORTANT: vLLM servers run on HOST machine for direct GPU access
# This compose file handles: Redis, ChromaDB, and RAG Application
#
# Usage:
#   1. Start vLLM servers on host (see scripts/start_vllm.sh)
#   2. Run: docker-compose up -d
#   3. Access app at http://localhost:8080
#
# =============================================================================

services:
  # ===========================================================================
  # REDIS - Caching Layer
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: rag_redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --save 60 1 --loglevel warning --maxmemory 2gb --maxmemory-policy allkeys-lru
    restart: unless-stopped
    networks:
      - rag_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # ===========================================================================
  # CHROMADB - Vector Database (Optional - can use embedded mode)
  # ===========================================================================
  chromadb:
    image: chromadb/chroma:0.5.0
    container_name: rag_chromadb
    ports:
      - "${CHROMA_PORT:-8003}:8000"
    volumes:
      - chroma_data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
      - CHROMA_SERVER_AUTHN_PROVIDER=
    restart: unless-stopped
    networks:
      - rag_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # RAG APPLICATION - Chainlit + LangGraph
  # ===========================================================================
  rag_app:
    build:
      context: ..
      dockerfile: Docker/Dockerfile
    container_name: rag_app
    depends_on:
      redis:
        condition: service_healthy
      chromadb:
        condition: service_healthy
    environment:
      # Service connections (Docker internal)
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - CHROMA_HOST=${CHROMA_HOST:-chromadb}
      - CHROMA_PORT=8000

      # vLLM endpoints (on HOST machine)
      - VISION_URL=${VISION_URL:-http://host.docker.internal:8006/v1}
      - REASONING_URL=${REASONING_URL:-http://host.docker.internal:8005/v1}

      # Model configuration
      - VISION_MODEL=${VISION_MODEL:-Qwen/Qwen2.5-VL-3B-Instruct}
      - REASONING_MODEL=${REASONING_MODEL:-deepseek-ai/DeepSeek-R1-Distill-Qwen-7B}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-nomic-ai/nomic-embed-text-v1.5}
      - RERANKER_MODEL=${RERANKER_MODEL:-cross-encoder/ms-marco-MiniLM-L-6-v2}

      # Cache settings
      - CACHE_ENABLED=${CACHE_ENABLED:-true}
      - CACHE_TTL_SECONDS=${CACHE_TTL_SECONDS:-3600}
      - CACHE_SIMILARITY_THRESHOLD=${CACHE_SIMILARITY_THRESHOLD:-0.95}

      # Routing settings
      - ROUTING_ENABLED=${ROUTING_ENABLED:-true}

      # Generation settings
      - TEMPERATURE=${TEMPERATURE:-0.3}
      - MAX_TOKENS=${MAX_TOKENS:-2048}

      # Python settings
      - PYTHONPATH=/workspace/src
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - HF_HOME=/workspace/huggingface
      - TRANSFORMERS_CACHE=/workspace/huggingface
      - HF_HUB_ENABLE_HF_TRANSFER=1
      - HF_HUB_OFFLINE=1
      - TRANSFORMERS_OFFLINE=1
      - NVIDIA_VISIBLE_DEVICES=all
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      # Mount source for development (remove in production for faster startup)
      - ../src:/workspace/src:ro
      # Persistent data
      - ../data:/workspace/data
      - app_chroma_db:/workspace/chroma_db
    ports:
      - "${RAG_APP_PORT:-8080}:8000"
    extra_hosts:
      # Allow container to access host machine
      - "host.docker.internal:host-gateway"
    dns:
      - 8.8.8.8
      - 8.8.4.4
    runtime: nvidia
    mem_limit: 16g
    restart: unless-stopped
    networks:
      - rag_network

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  redis_data:
    driver: local
  chroma_data:
    driver: local
  app_chroma_db:
    driver: local

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  rag_network:
    driver: bridge
